import streamlit as st
from frontend.ui.utils.client_manager import ClientManager
from frontend.ui.components.chat import ChatInterface  # Chat UI ì¬ì‚¬ìš©

# í˜ì´ì§€ ì„¤ì • - ì¸í„°ë™í‹°ë¸Œ ë ˆí¼ëŸ°ìŠ¤ ì‹œìŠ¤í…œ ì†Œê°œ
st.set_page_config(
    page_title="GTOne RAG Chat - Interactive References",
    page_icon="ğŸ”—",
    layout="wide",
    menu_items={
        'About': """
        # GTOne RAG Chat - Interactive References

        ## ğŸš€ ì¸í„°ë™í‹°ë¸Œ ë ˆí¼ëŸ°ìŠ¤ ì‹œìŠ¤í…œ
        - **ìŠ¤ë§ˆíŠ¸ ë ˆí¼ëŸ°ìŠ¤**: AI ë‹µë³€ì— ìë™ìœ¼ë¡œ ì°¸ì¡° ë²ˆí˜¸ ì‚½ì…
        - **í˜¸ë²„ ë¯¸ë¦¬ë³´ê¸°**: ì°¸ì¡° ë²ˆí˜¸ì— ë§ˆìš°ìŠ¤ ì˜¬ë ¤ ì¦‰ì‹œ í™•ì¸
        - **í´ë¦­ ë„¤ë¹„ê²Œì´ì…˜**: ì°¸ì¡° ë²ˆí˜¸ í´ë¦­ìœ¼ë¡œ í•´ë‹¹ ê·¼ê±°ë¡œ ì´ë™
        - **ì–‘ë°©í–¥ ì´ë™**: ê·¼ê±°ì—ì„œ ë³¸ë¬¸ìœ¼ë¡œ ëŒì•„ê°€ëŠ” â†‘ ë²„íŠ¼
        - **í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤**: Ctrl+ìˆ«ìë¡œ ë¹ ë¥¸ ê·¼ê±° ì´ë™

        ## ğŸ¯ ê·¼ê±° í‘œì‹œ ê°•í™”
        - **ì‹ ë¢°ë„ ì ìˆ˜**: ê´€ë ¨ë„ ë¶„ì„ ë° ì¸ìš©ë¬¸ ì¶”ì¶œ
        - **ìŠ¤ë§ˆíŠ¸ í•„í„°ë§**: ì‹ ë¢°ë„ ê¸°ì¤€ í•„í„°ë§, í’ˆì§ˆ ë“±ê¸‰ ë¶„ë¥˜
        - **ì‹œê°ì  íš¨ê³¼**: í•˜ì´ë¼ì´íŒ… ë° ë¶€ë“œëŸ¬ìš´ ì• ë‹ˆë©”ì´ì…˜
        - **ì„¸ì…˜ ë¶„ì„**: ëŒ€í™” í’ˆì§ˆ ë¶„ì„ ë° ê·¼ê±° í’ˆì§ˆ ê²€í† 

        ## ğŸ’¡ ì‚¬ìš© íŒ
        1. ë‹µë³€ ì† [1], [2] ë“±ì˜ ì°¸ì¡° ë²ˆí˜¸ì— ë§ˆìš°ìŠ¤ë¥¼ ì˜¬ë ¤ ë¯¸ë¦¬ë³´ê¸° í™•ì¸
        2. ì°¸ì¡° ë²ˆí˜¸ë¥¼ í´ë¦­í•˜ì—¬ ìƒì„¸ ê·¼ê±°ë¡œ ì´ë™
        3. ê·¼ê±° ì¹´ë“œì˜ â†‘ ë²„íŠ¼ìœ¼ë¡œ ì½ë˜ ìœ„ì¹˜ë¡œ ëŒì•„ê°€ê¸°
        4. Ctrl+1~9 í‚¤ë¡œ í•´ë‹¹ ë²ˆí˜¸ì˜ ê·¼ê±°ë¡œ ë¹ ë¥¸ ì´ë™
        5. ì‚¬ì´ë“œë°”ì—ì„œ ì‹ ë¢°ë„ ê¸°ì¤€ê³¼ ì •ë ¬ ë°©ì‹ ì¡°ì •
        """
    }
)

# ì‚¬ì´ë“œë°”ì— ê¸°ëŠ¥ ì•ˆë‚´
with st.sidebar:
    st.markdown("### ğŸ”— ì¸í„°ë™í‹°ë¸Œ ë ˆí¼ëŸ°ìŠ¤")
    st.markdown("""
    **âœ¨ ìƒˆë¡œìš´ ê¸°ëŠ¥!**
    - ë‹µë³€ ì† ì°¸ì¡° ë²ˆí˜¸ í´ë¦­
    - í˜¸ë²„ ì‹œ ë¯¸ë¦¬ë³´ê¸° íŒì—…
    - ì–‘ë°©í–¥ ë„¤ë¹„ê²Œì´ì…˜
    - í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤ (Ctrl+ìˆ«ì)
    """)

    st.markdown("### ğŸ¯ ê·¼ê±° í‘œì‹œ ì„¤ì •")
    st.markdown("""
    **ì‹ ë¢°ë„ í•„í„°**: ë‚®ì€ í’ˆì§ˆì˜ ê·¼ê±° ì œì™¸
    **ì •ë ¬ ë°©ì‹**: ê·¼ê±° í‘œì‹œ ìˆœì„œ ì¡°ì •
    **ìƒì„¸ í‘œì‹œ**: ë©”íƒ€ë°ì´í„° ë° í†µê³„ í™•ì¸
    """)

    st.divider()

    # ë ˆí¼ëŸ°ìŠ¤ ì‹œìŠ¤í…œ ê°€ì´ë“œ ë§í¬
    if st.button("ğŸ“– ë ˆí¼ëŸ°ìŠ¤ ê°€ì´ë“œ ë³´ê¸°"):
        # ê°€ì´ë“œ ëª¨ë‹¬ ë˜ëŠ” expanderë¡œ í‘œì‹œ
        with st.expander("ğŸ”— ì¸í„°ë™í‹°ë¸Œ ë ˆí¼ëŸ°ìŠ¤ ì‹œìŠ¤í…œ ê°€ì´ë“œ", expanded=True):
            st.markdown("""
            #### ğŸ¯ ì£¼ìš” ê¸°ëŠ¥

            **ğŸ“ ìŠ¤ë§ˆíŠ¸ ë ˆí¼ëŸ°ìŠ¤**
            - ë‹µë³€ì— ìë™ìœ¼ë¡œ ì°¸ì¡° ë²ˆí˜¸ [1], [2] ì‚½ì…
            - ë¬¸ë§¥ì— ë§ëŠ” ìµœì  ìœ„ì¹˜ ì„ íƒ

            **ğŸ–±ï¸ ì¸í„°ë™ì…˜**
            - ì°¸ì¡° ë²ˆí˜¸ **í˜¸ë²„**: ë¯¸ë¦¬ë³´ê¸° íŒì—…
            - ì°¸ì¡° ë²ˆí˜¸ **í´ë¦­**: í•´ë‹¹ ê·¼ê±°ë¡œ ì´ë™
            - ê·¼ê±°ì˜ **â†‘ ë²„íŠ¼**: ë³¸ë¬¸ìœ¼ë¡œ ëŒì•„ê°€ê¸°

            **âŒ¨ï¸ í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤**
            - `Ctrl + 1~9`: í•´ë‹¹ ë²ˆí˜¸ ê·¼ê±°ë¡œ ë¹ ë¥¸ ì´ë™

            **ğŸ’¡ ì‚¬ìš© íŒ**
            1. ì°¸ì¡° ë²ˆí˜¸ì— ë§ˆìš°ìŠ¤ ì˜¬ë ¤ ë¹ ë¥¸ í™•ì¸
            2. í´ë¦­ìœ¼ë¡œ ìƒì„¸ ê·¼ê±° íƒìƒ‰  
            3. â†‘ ë²„íŠ¼ìœ¼ë¡œ ì½ë˜ ìœ„ì¹˜ë¡œ ë³µê·€
            4. í‚¤ë³´ë“œë¡œ ë¹ ë¥¸ ë„¤ë¹„ê²Œì´ì…˜
            """)

    # ë„ì›€ë§ ì„¹ì…˜
    with st.expander("â“ ì‚¬ìš© ë„ì›€ë§", expanded=False):
        st.markdown("""
        **ê·¼ê±° ì‹ ë¢°ë„ ì´í•´**
        - ğŸŸ¢ 80% ì´ìƒ: ë§¤ìš° ì‹ ë¢°í•  ë§Œí•œ ê·¼ê±°
        - ğŸŸ¡ 60-80%: ì ì ˆí•œ ê·¼ê±°
        - ğŸ”´ 40-60%: ì£¼ì˜í•´ì„œ ì°¸ê³ 
        - âšª 40% ë¯¸ë§Œ: ë‚®ì€ ì‹ ë¢°ë„

        **ê·¼ê±° í’ˆì§ˆ ë“±ê¸‰**
        - A+/A: ìš°ìˆ˜í•œ í’ˆì§ˆ
        - B+/B: ì–‘í˜¸í•œ í’ˆì§ˆ  
        - C+/C: ê°œì„  í•„ìš”

        **ë ˆí¼ëŸ°ìŠ¤ ë„¤ë¹„ê²Œì´ì…˜**
        - ì°¸ì¡° ë²ˆí˜¸ í´ë¦­: í•´ë‹¹ ê·¼ê±°ë¡œ ì´ë™
        - í˜¸ë²„ ë¯¸ë¦¬ë³´ê¸°: ë¹ ë¥¸ ë‚´ìš© í™•ì¸
        - ì–‘ë°©í–¥ ì´ë™: ë³¸ë¬¸ â†” ê·¼ê±° ììœ  íƒìƒ‰
        """)

# ë©”ì¸ ì±„íŒ… ì¸í„°í˜ì´ìŠ¤
# ğŸ”§ í´ë¼ì´ì–¸íŠ¸ ìºì‹±ìœ¼ë¡œ ë¶ˆí•„ìš”í•œ ì¬ìƒì„± ë°©ì§€
if 'api_client_cached' not in st.session_state:
    st.session_state.api_client_cached = ClientManager.get_client()

api_client = st.session_state.api_client_cached

# ğŸ”§ í´ë¼ì´ì–¸íŠ¸ ìœ íš¨ì„± ê²€ì‚¬ (10ë¶„ë§ˆë‹¤)
if not ClientManager.is_client_valid():
    st.session_state.api_client_cached = ClientManager.get_client(force_refresh=True)
    api_client = st.session_state.api_client_cached

chat_interface = ChatInterface(api_client)

# ğŸš€ ë ˆí¼ëŸ°ìŠ¤ ì‹œìŠ¤í…œ ì†Œê°œ (ì²« ë°©ë¬¸ ì‹œ)
if 'reference_intro_shown' not in st.session_state:
    st.session_state.reference_intro_shown = True

    st.info("""
    ğŸ”— **ìƒˆë¡œìš´ ì¸í„°ë™í‹°ë¸Œ ë ˆí¼ëŸ°ìŠ¤ ì‹œìŠ¤í…œì´ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤!**

    ì´ì œ AI ë‹µë³€ ì† ì°¸ì¡° ë²ˆí˜¸ [1], [2]ë¥¼ í´ë¦­í•˜ë©´ í•´ë‹¹ ê·¼ê±°ë¡œ ë°”ë¡œ ì´ë™í•  ìˆ˜ ìˆê³ , 
    ë§ˆìš°ìŠ¤ë¥¼ ì˜¬ë¦¬ë©´ ë¯¸ë¦¬ë³´ê¸° íŒì—…ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. 

    ë” ìì„¸í•œ ì‚¬ìš©ë²•ì€ ì‚¬ì´ë“œë°”ì˜ "ğŸ“– ë ˆí¼ëŸ°ìŠ¤ ê°€ì´ë“œ ë³´ê¸°"ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.
    """)

# ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§ì„ ìœ„í•œ ë©”íŠ¸ë¦­
if 'chat_metrics' not in st.session_state:
    st.session_state.chat_metrics = {
        'total_queries': 0,
        'high_quality_responses': 0,
        'avg_response_time': 0,
        'reference_clicks': 0  # ğŸš€ ë ˆí¼ëŸ°ìŠ¤ í´ë¦­ ìˆ˜ ì¶”ê°€
    }

# ì±„íŒ… ì¸í„°í˜ì´ìŠ¤ ë Œë”ë§
chat_interface.render()

# í•˜ë‹¨ì— ì„±ëŠ¥ ì§€í‘œ í‘œì‹œ (ì„ íƒì )
if st.session_state.get('messages', []):
    with st.expander("ğŸ“ˆ ì„¸ì…˜ ì„±ëŠ¥ ì§€í‘œ", expanded=False):
        metrics = st.session_state.chat_metrics

        col1, col2, col3, col4 = st.columns(4)
        with col1:
            st.metric("ì´ ì§ˆë¬¸ ìˆ˜", metrics['total_queries'])
        with col2:
            st.metric("ê³ í’ˆì§ˆ ì‘ë‹µ", metrics['high_quality_responses'])
        with col3:
            st.metric("í‰ê·  ì‘ë‹µì‹œê°„", f"{metrics['avg_response_time']:.1f}ì´ˆ")
        with col4:
            st.metric("ë ˆí¼ëŸ°ìŠ¤ í™œìš©", metrics.get('reference_clicks', 0))

# í”¼ë“œë°± ìˆ˜ì§‘
st.divider()
feedback_col1, feedback_col2 = st.columns([3, 1])

with feedback_col1:
    st.markdown("**ğŸ’¬ ì¸í„°ë™í‹°ë¸Œ ë ˆí¼ëŸ°ìŠ¤ ì‹œìŠ¤í…œì— ëŒ€í•œ í”¼ë“œë°±ì„ ë‚¨ê²¨ì£¼ì„¸ìš”**")

with feedback_col2:
    if st.button("ğŸ“ í”¼ë“œë°± ì œì¶œ"):
        st.info("í”¼ë“œë°±ì´ ê°œë°œíŒ€ì— ì „ë‹¬ë©ë‹ˆë‹¤. ê°ì‚¬í•©ë‹ˆë‹¤!")